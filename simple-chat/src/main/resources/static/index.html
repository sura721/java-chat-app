<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dark Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* DARK MODE CSS */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        /* AUTH BOX */
        .auth-box { background: #1e1e1e; padding: 40px; border-radius: 10px; width: 320px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #2c2c2c; border: 1px solid #444; border-radius: 5px; color: white; box-sizing: border-box; }
        input:focus { outline: none; border-color: #00a884; }
        button { width: 100%; padding: 12px; background: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:hover { background: #008f6f; }
        .link { color: #00a884; font-size: 13px; cursor: pointer; margin-top: 15px; display: block; }

        /* APP LAYOUT */
        .app-container { display: flex; width: 950px; height: 90vh; background: #1e1e1e; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        /* SIDEBAR */
        .sidebar { width: 30%; background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #2b2b2b; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .user-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .user-item:hover { background: #2a2d2e; }
        .user-item.active { background: #37373d; border-left: 3px solid #00a884; }
        .avatar { width: 40px; height: 40px; background: #555; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; font-weight: bold; color: white; }
        
        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #0b141a; /* Very dark blue/black */ }
        .chat-header { padding: 15px; background: #2b2b2b; border-bottom: 1px solid #333; display: flex; align-items: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; }
        .my-message { align-self: flex-end; background: #005c4b; color: #e9edef; }
        .other-message { align-self: flex-start; background: #202c33; color: #e9edef; }
        
        .input-area { padding: 15px; background: #2b2b2b; display: flex; gap: 10px; align-items: center; }
        .input-area input { margin: 0; background: #3a3b3c; border: none; }
        
        .empty-state { margin: auto; color: #888; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #222; }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-screen" class="auth-box">
        <h2 style="color: white;">Dark Chat</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <span class="link" onclick="toggleScreen('signup')">Create Account</span>
    </div>

    <!-- 2. SIGNUP -->
    <div id="signup-screen" class="auth-box hidden">
        <h2 style="color: white;">Join Us</h2>
        <input type="text" id="s-username" placeholder="New Username">
        <input type="password" id="s-password" placeholder="New Password">
        <button onclick="signup()">Sign Up</button>
        <span class="link" onclick="toggleScreen('login')">Back to Login</span>
    </div>

    <!-- 3. MAIN APP -->
    <div id="app-screen" class="app-container hidden">
        
        <div class="sidebar">
            <div class="sidebar-header">
                <span id="my-name" style="font-weight: bold;">Me</span>
                <button onclick="logout()" style="width: auto; padding: 6px 12px; font-size: 12px; background: #d32f2f;">Logout</button>
            </div>
            <ul id="user-list" class="user-list"></ul>
        </div>

        <div class="chat-area">
            <div class="chat-header hidden" id="chat-header">
                <div class="avatar" id="chat-avatar">?</div>
                <span id="chat-name" style="font-weight: bold;">User</span>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="empty-state">Select a contact to start chatting</div>
            </div>

            <div id="input-area" class="input-area hidden">
                <!-- ENTER KEY LOGIC HERE -->
                <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()" style="width: 60px;">âž¤</button>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentUser = null;
        let selectedUser = null;

        function toggleScreen(screen) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('signup-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById(screen + '-screen').classList.remove('hidden');
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/user/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const user = await res.json();
            if (user) {
                currentUser = user;
                document.getElementById('my-name').innerText = user.username;
                toggleScreen('app');
                connectSocket();
                loadUsers();
            } else { alert("Invalid login"); }
        }

        async function signup() {
            const u = document.getElementById('s-username').value;
            const p = document.getElementById('s-password').value;
            const res = await fetch('/user/register', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const text = await res.text();
            if (text === "Success") { alert("Created! Login now."); toggleScreen('login'); }
            else { alert(text); }
        }

        async function loadUsers() {
            const res = await fetch('/user/all');
            const users = await res.json();
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            users.forEach(u => {
                if (u.username === currentUser.username) return; 
                const li = document.createElement('li');
                li.className = "user-item";
                li.onclick = () => selectContact(u.username, li);
                li.innerHTML = `<div class="avatar">${u.username.charAt(0).toUpperCase()}</div> ${u.username}`;
                list.appendChild(li);
            });
        }

        async function selectContact(username, element) {
            selectedUser = username;
            document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('input-area').classList.remove('hidden');
            document.getElementById('chat-name').innerText = username;
            document.getElementById('chat-avatar').innerText = username.charAt(0).toUpperCase();
            
            // --- LOAD HISTORY (Persistence Fix) ---
            const container = document.getElementById('chat-messages');
            container.innerHTML = ''; // Clear previous view
            
            const res = await fetch(`/messages/${currentUser.username}/${selectedUser}`);
            const messages = await res.json();
            
            messages.forEach(msg => {
                const type = msg.senderId === currentUser.username ? 'my' : 'other';
                displayMessage(msg.content, type);
            });
        }

        function connectSocket() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, frame => {
                stompClient.subscribe('/user/' + currentUser.username + '/private', msg => {
                    const message = JSON.parse(msg.body);
                    if (selectedUser === message.senderId) {
                        displayMessage(message.content, 'other');
                    }
                });
            });
        }

        // --- ENTER KEY HANDLER ---
        function handleEnter(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (content && selectedUser) {
                const msg = {
                    senderId: currentUser.username,
                    recipientId: selectedUser,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                stompClient.send("/app/private-message", {}, JSON.stringify(msg));
                displayMessage(content, 'my');
                input.value = "";
            }
        }

        function displayMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}-message`;
            div.innerText = text;
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function logout() {
            if (stompClient) stompClient.disconnect();
            location.reload();
        }
    </script>
</body>
</html>